<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>History Page</title>
  <link rel="stylesheet" href="/css/themes.css" />
  <script src="/assets/themes.js" type="module"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="/pages/history.ico" type="image/x-icon" />
  <link href="/css/history.css" rel="stylesheet">
</head>

<body>

  <div class="container">
    <div class="header">
      <h1>History</h1>
      <input type="text" class="searchBar" placeholder="Search History">
    </div>

    <button class="deleteBtn" id="deleteBtn">Delete</button>

    <div id="historyEntries"></div>
  </div>
  <script type="module">
    import { HistoryHelper } from "/assets/history_helper.js";
    import { SettingsManager } from "/assets/settings_manager.js";

    self.history_helper = new HistoryHelper();
    self.settings = new SettingsManager();
    startLoad();
  </script>
  <script>

    //To-do: replace temp ai code :sob:
    async function startLoad() {
      let text;
      if (!await self.settings.get("history")) text = "Enable your history to begin!";
      else text = "Start by searching something!";
      const savedHistory = await self.history_helper.get();
      const historyData = savedHistory.length > 0 ? savedHistory : [{ time: text, title: "Nothings here yet!", url: "http://example.com", icon: "https://google.com/favicon.ico" }];
      const historyEntries = document.getElementById('historyEntries');
      const deleteBtn = document.getElementById('deleteBtn');
      let selectedItems = [];

      function formatDate(date) {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        if(typeof date === "number") date = new Date(date);

        if (date.toDateString() === today.toDateString()) {
          return "Today";
        } else if (date.toDateString() === yesterday.toDateString()) {
          return "Yesterday";
        } else {
          return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
        }
      }

      function renderHistory() {
        const groupedData = {};

        historyData.forEach(item => {
          const dateKey = formatDate(new Date());
          if (!groupedData[dateKey]) {
            groupedData[dateKey] = [];
          }
          groupedData[dateKey].push(item);
        });

        for (const [date, items] of Object.entries(groupedData)) {
          const daySection = document.createElement('div');
          daySection.classList.add('day-section');
          daySection.innerHTML = `<h2>${date}</h2>`;

          const historyList = document.createElement('div');
          historyList.classList.add('history-list');

          items.forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.classList.add('history-item');

            historyItem.innerHTML = `
                        <div class="history-info">
                            <img src="${item.icon}" class="favicon" alt="favicon">
                            <div>
                                <div class="history-title">${item.title}</div>
                                <div class="history-time">${item.time}</div>
                            </div>
                        </div>
                        <div class="history-actions">
                            <input type="checkbox" class="select-item" data-link="${item.url}">
                        </div>
                    `;

            historyList.appendChild(historyItem);
          });

          daySection.appendChild(historyList);
          historyEntries.appendChild(daySection);
        }

        document.querySelectorAll('.select-item').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const link = e.target.dataset.link;
            if (e.target.checked) {
              selectedItems.push(link);
            } else {
              selectedItems = selectedItems.filter(item => item !== link);
            }

            if (selectedItems.length > 0) {
              deleteBtn.classList.add('show');
            } else {
              deleteBtn.classList.remove('show');
            }
          });
        });
      }


      deleteBtn.addEventListener('click', () => {
        // Filter out the deleted items from history
        const remainingHistory = historyData.filter(item => !selectedItems.includes(item.link));
        selectedItems = [];

        // Clear the content and re-render the updated history
        historyEntries.innerHTML = '';
        deleteBtn.classList.remove('show');
        renderHistory();
      });

      // Initial render
      renderHistory();
    }
  </script>
</body>

</html>